<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°èªç¾…é¦¬å­—ç ”ç¿’ç‡Ÿå ±åç¾æ³å„€è¡¨æ¿</title>
    <!-- è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- è¼‰å…¥ Inter å­—é«” -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: #f0f4f8; /* æ·ºè—ç°è‰²åº• */
        }
        /* è«è˜­è¿ªè‰²èª¿ */
        .morandi-bg-light { background-color: #dddccf; } /* æ·ºç°ç±³è‰² */
        .morandi-text-dark { color: #5a5a49; } /* æ·±ç¶ ç°æ–‡å­— */
        .morandi-accent { background-color: #92b4a3; } /* è«è˜­è¿ªç¶ å¼·èª¿è‰² */
        /* ç¬¬ä¸€å€‹å¡ç‰‡çš„æ·±è‰²ç³» (ä¿ç•™çµ¦å–®ä¸€å¡ç‰‡ä½¿ç”¨) */
        .morandi-bg-darkblue { background-color: #8d99ae; } /* è«è˜­è¿ªæ·±è— */
        .morandi-text-contrast { color: #2b2d42; } /* è¼ƒæ·±çš„æ–‡å­—è‰² - ç”¨æ–¼å ±åäººæ•¸æ•¸å­— */

        .dashboard-container {
            max-width: 1200px;
            margin: 3rem auto;
            padding: 2rem;
        }
        .card {
            background-color: #ffffff;
            border-radius: 1rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            padding: 1.5rem;
            transition: transform 0.3s ease;
        }
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body>

    <div class="dashboard-container">
        <header class="text-center pb-8 mb-8 border-b border-gray-300">
            <h1 class="text-4xl font-extrabold morandi-text-dark">
                å°èªç¾…é¦¬å­—ç ”ç¿’ç‡Ÿ å ±åç¾æ³å„€è¡¨æ¿
            </h1>
            <p id="updateTime" class="text-lg mt-2 text-gray-500">è³‡æ–™æ›´æ–°ä¸­...</p>
        </header>

        <!-- ç¸½è¦½æŒ‡æ¨™å€å¡Š (åˆä½µç‚ºå–®ä¸€æ¬„ä½é¡¯ç¤ºç¸½å ±åäººæ•¸) -->
        <div id="summary-metrics" class="grid grid-cols-1 gap-6 mb-12">
            <!-- ç¸½å ±åäººæ•¸ - å–®ä¸€å¡ç‰‡ -->
            <div class="card morandi-bg-darkblue text-white text-center p-8">
                <!-- æ¨™é¡Œæ–‡å­—ä»ä¿æŒç™½è‰²ï¼Œä»¥åˆ©é–±è®€ -->
                <p class="text-2xl opacity-80">ç¸½å ±åäººæ•¸</p>
                
                <!-- å ±åäººæ•¸æ•¸å­—æ”¹ç‚ºæ·±è‰² morandi-text-contrast: #2b2d42 -->
                <p id="totalCount" class="text-7xl font-extrabold mt-3 morandi-text-contrast">0</p>
                
                <!-- è¨»è§£æ–‡å­—ä»ä¿æŒç™½è‰² -->
                <p class="text-xl opacity-70 mt-4">ï¼ˆå ±åé™é¡ï¼š50 äººï¼Œå³æ™‚æ›´æ–°ï¼‰</p>
            </div>
        </div>

        <!-- ç´°ç¯€åˆ†ä½ˆå€å¡Š -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- è·ç¨±åˆ†ä½ˆ -->
            <div class="card">
                <h2 class="text-2xl font-semibold morandi-text-dark mb-4 border-b pb-2">ğŸ©º è·ç¨±åˆ†ä½ˆ (Top 5)</h2>
                <div id="titleChart" class="space-y-4">
                    <p class="text-gray-500">è¼‰å…¥ä¸­...</p>
                </div>
            </div>

            <!-- å°èªç¨‹åº¦åˆ†ä½ˆ -->
            <div class="card">
                <h2 class="text-2xl font-semibold morandi-text-dark mb-4 border-b pb-2">ğŸ—£ï¸ å°èªç¨‹åº¦åˆ†ä½ˆ</h2>
                <div id="levelChart" class="space-y-4">
                    <p class="text-gray-500">è¼‰å…¥ä¸­...</p>
                </div>
            </div>

            <!-- åƒåŠ å‹•æ©Ÿçµ±è¨ˆ -->
            <div class="card lg:col-span-2">
                <h2 class="text-2xl font-semibold morandi-text-dark mb-4 border-b pb-2">ğŸ’¡ åƒåŠ å‹•æ©Ÿçµ±è¨ˆ</h2>
                <div id="motivationChart" class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                    <p class="text-gray-500 sm:col-span-2">è¼‰å…¥ä¸­...</p>
                </div>
            </div>
            
            <!-- å–®ä½ï¼ç§‘åˆ¥æ’å (Top 5) -->
            <div class="card lg:col-span-2">
                <h2 class="text-2xl font-semibold morandi-text-dark mb-4 border-b pb-2">ğŸ¥ å–®ä½ï¼ç§‘åˆ¥æ’å (Top 10)</h2>
                <div id="departmentTable" class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æ’å</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">å–®ä½ï¼ç§‘åˆ¥</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">å ±åäººæ•¸</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <tr><td colspan="3" class="px-4 py-4 text-sm text-gray-500">è¼‰å…¥ä¸­...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- éŒ¯èª¤è¨Šæ¯ -->
        <div id="error-message" class="hidden fixed top-4 right-4 bg-red-100 text-red-800 p-3 rounded-lg shadow-lg" role="alert">
            è³‡æ–™è¼‰å…¥å¤±æ•—ã€‚
        </div>

    </div>

    <script>
        // -----------------------------------------------------
        // Google Apps Script Web App URL (èˆ‡å ±åè¡¨ç›¸åŒ)
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxkp8KVN9lI5qy_wkfdx3lV_mQH0fectd-zJDJqqtwyUXHgjY-kL48HM0B12hp3fib4/exec'; 
        const REGISTRATION_LIMIT = 50;
        // -----------------------------------------------------
        
        // åƒ…ä¿ç•™ç¸½å ±åäººæ•¸çš„å…ƒç´ å¼•ç”¨
        const totalCountEl = document.getElementById('totalCount');
        const updateTimeEl = document.getElementById('updateTime');
        const errorMessageEl = document.getElementById('error-message');

        const titleChartEl = document.getElementById('titleChart');
        const levelChartEl = document.getElementById('levelChart');
        const motivationChartEl = document.getElementById('motivationChart');
        const departmentTableEl = document.getElementById('departmentTable');

        // é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
        function showMessage(message) {
            errorMessageEl.textContent = message;
            errorMessageEl.classList.remove('hidden');
            setTimeout(() => {
                errorMessageEl.classList.add('hidden');
            }, 8000);
        }

        // è¼”åŠ©å‡½å¼ï¼šè¨ˆç®—é »ç‡
        function countFrequencies(dataArray) {
            return dataArray.reduce((acc, item) => {
                // æ’é™¤ç©ºå€¼
                if (item) {
                    acc[item] = (acc[item] || 0) + 1;
                }
                return acc;
            }, {});
        }
        
        // è¼”åŠ©å‡½å¼ï¼šè™•ç†å¤šé¸æ¬„ä½ (å¦‚åƒåŠ å‹•æ©Ÿï¼Œä»¥åˆ†è™Ÿåˆ†éš”)
        function countMultiSelectFrequencies(dataArray) {
            const counts = {};
            dataArray.forEach(item => {
                if (item) {
                    const motives = item.split(';').map(m => m.trim()).filter(m => m);
                    motives.forEach(m => {
                        counts[m] = (counts[m] || 0) + 1;
                    });
                }
            });
            return counts;
        }

        // è¼”åŠ©å‡½å¼ï¼šå°‡é »ç‡è½‰æ›ç‚ºå¯ç¹ªåœ–çš„é™£åˆ— (åŒ…å«ç™¾åˆ†æ¯”)
        function formatDataForChart(frequencies, total) {
            return Object.entries(frequencies)
                .map(([name, count]) => ({
                    name,
                    count,
                    percentage: ((count / total) * 100).toFixed(1)
                }))
                .sort((a, b) => b.count - a.count); // é™å†ªæ’åº
        }

        // ç¹ªè£½é•·æ¢åœ–
        function renderBarChart(element, data, total) {
            element.innerHTML = ''; // æ¸…ç©ºèˆŠå…§å®¹
            if (total === 0) {
                element.innerHTML = '<p class="text-gray-500">ç›®å‰å°šç„¡å ±åè³‡æ–™ã€‚</p>';
                return;
            }

            data.forEach(item => {
                const barWidth = item.percentage > 0 ? item.percentage : 0.5; // æœ€å°å¯¬åº¦
                
                const barHtml = `
                    <div class="flex flex-col sm:flex-row items-start sm:items-center space-y-1 sm:space-y-0">
                        <div class="w-full sm:w-1/3 font-medium morandi-text-dark text-sm pr-4">${item.name}</div>
                        <div class="w-full sm:w-2/3 flex items-center">
                            <div class="h-4 morandi-accent rounded-full shadow-inner" style="width: ${barWidth}%;"></div>
                            <span class="ml-3 text-sm font-semibold text-gray-700">${item.count} äºº (${item.percentage}%)</span>
                        </div>
                    </div>
                `;
                element.insertAdjacentHTML('beforeend', barHtml);
            });
        }
        
        // ç¹ªè£½è¡¨æ ¼
        function renderTable(element, data) {
            const tbody = element.querySelector('tbody');
            tbody.innerHTML = '';

            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" class="px-4 py-4 text-sm text-gray-500">ç›®å‰å°šç„¡å ±åè³‡æ–™ã€‚</td></tr>';
                return;
            }

            data.slice(0, 10).forEach((item, index) => { // åƒ…é¡¯ç¤º Top 10
                const rowHtml = `
                    <tr class="${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}">
                        <td class="px-4 py-2 text-sm font-medium text-gray-900">${index + 1}</td>
                        <td class="px-4 py-2 text-sm text-gray-700">${item.name}</td>
                        <td class="px-4 py-2 text-sm text-gray-700 font-semibold">${item.count}</td>
                    </tr>
                `;
                tbody.insertAdjacentHTML('beforeend', rowHtml);
            });
        }

        // ä¸»è³‡æ–™è™•ç†å‡½å¼
        async function fetchAndRenderDashboard() {
            try {
                // ç™¼é€ GET è«‹æ±‚åˆ° Apps Script Web App è®€å–è³‡æ–™
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'GET',
                    mode: 'cors', 
                    cache: 'no-cache'
                });

                if (!response.ok) {
                    throw new Error(`HTTP éŒ¯èª¤: ${response.status}`);
                }
                
                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.message || 'Apps Script å›å‚³å¤±æ•—è¨Šæ¯');
                }

                const rawData = result.data;
                const total = rawData.length;

                // --- 1. ç¸½è¦½æŒ‡æ¨™ (å–®ä¸€æ¬„é¡¯ç¤ºç¸½å ±åäººæ•¸) ---
                totalCountEl.textContent = total;

                // --- 2. è·ç¨±åˆ†ä½ˆ ---
                const titleData = formatDataForChart(countFrequencies(rawData.map(d => d['è·ç¨±'])), total);
                renderBarChart(titleChartEl, titleData.slice(0, 5), total); // åƒ…é¡¯ç¤º Top 5

                // --- 3. å°èªç¨‹åº¦åˆ†ä½ˆ ---
                const levelData = formatDataForChart(countFrequencies(rawData.map(d => d['å°èªç¨‹åº¦'])), total);
                renderBarChart(levelChartEl, levelData, total);

                // --- 4. åƒåŠ å‹•æ©Ÿçµ±è¨ˆ ---
                const motivationCounts = countMultiSelectFrequencies(rawData.map(d => d['åƒåŠ å‹•æ©Ÿ']));
                const motivationData = formatDataForChart(motivationCounts, total);
                // ä½¿ç”¨ grid-cols-2 ä½ˆå±€
                motivationChartEl.className = "grid grid-cols-1 sm:grid-cols-2 gap-6"; 
                renderBarChart(motivationChartEl, motivationData, total);


                // --- 5. å–®ä½ï¼ç§‘åˆ¥æ’å ---
                const departmentCounts = countFrequencies(rawData.map(d => d['å–®ä½ï¼ç§‘åˆ¥']));
                const departmentData = formatDataForChart(departmentCounts, total); // æ ¼å¼åŒ–ç‚ºåŒ…å« name/count çš„é™£åˆ—
                renderTable(departmentTableEl, departmentData);
                
                // æ›´æ–°æ™‚é–“
                updateTimeEl.textContent = `è³‡æ–™æ›´æ–°æ™‚é–“: ${new Date().toLocaleString('zh-TW', {
                    year: 'numeric', month: '2-digit', day: '2-digit', 
                    hour: '2-digit', minute: '2-digit', second: '2-digit', 
                    hour12: false
                })}`;


            } catch (error) {
                console.error('å„€è¡¨æ¿è¼‰å…¥è³‡æ–™éŒ¯èª¤:', error);
                showMessage('è³‡æ–™è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¢ºèª Apps Script å·²æ­£ç¢ºéƒ¨ç½²ä¸”è¨­å®šäº† doGet å‡½å¼ã€‚' + error.message);
                totalCountEl.textContent = 'éŒ¯èª¤';
            }
        }

        // é é¢è¼‰å…¥å®Œæˆå¾ŒåŸ·è¡Œ
        window.onload = fetchAndRenderDashboard;
        
        // æ¯ 60 ç§’è‡ªå‹•æ›´æ–°ä¸€æ¬¡
        setInterval(fetchAndRenderDashboard, 60000); 

    </script>

</body>
</html>
